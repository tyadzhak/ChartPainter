<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSV to Line Chart</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            margin-top: 0;
        }
        .input-section {
            margin-bottom: 30px;
        }
        input[type="file"] {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
        }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-left: 10px;
        }
        button:hover {
            background-color: #45a049;
        }
        .chart-container {
            position: relative;
            height: 400px;
            margin-top: 30px;
            display: none;
        }
        .chart-container.show {
            display: block;
        }
        .error {
            color: #d32f2f;
            padding: 15px;
            background-color: #ffebee;
            border-radius: 4px;
            margin-top: 10px;
            display: none;
        }
        .error.show {
            display: block;
        }
        .info {
            color: #1976d2;
            padding: 15px;
            background-color: #e3f2fd;
            border-radius: 4px;
            margin-top: 10px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>CSV to Line Chart Generator</h1>
        
        <div class="input-section">
            <input type="file" id="csvFile" accept=".csv" />
            <button onclick="generateChart()">Generate Chart</button>
        </div>
        
        <div class="error" id="error"></div>
        
        <div class="info">
            <strong>How to use:</strong> Upload a CSV file where the first column contains X-axis labels and subsequent columns contain data series to plot.
        </div>
        
        <div class="chart-container" id="chartContainer">
            <canvas id="lineChart"></canvas>
        </div>
    </div>

    <script>
        let chart = null;

        function generateChart() {
            const fileInput = document.getElementById('csvFile');
            const errorDiv = document.getElementById('error');
            const chartContainer = document.getElementById('chartContainer');
            
            // Clear previous error
            errorDiv.classList.remove('show');
            errorDiv.textContent = '';
            
            if (!fileInput.files.length) {
                showError('Please select a CSV file first');
                return;
            }

            const file = fileInput.files[0];
            const reader = new FileReader();

            reader.onload = function(e) {
                try {
                    const csv = e.target.result;
                    const data = parseCSV(csv);
                    
                    if (data.labels.length === 0) {
                        showError('CSV file appears to be empty');
                        return;
                    }
                    
                    if (data.datasets.length === 0) {
                        showError('No data columns found in CSV file');
                        return;
                    }

                    chartContainer.classList.add('show');
                    createChart(data);
                } catch (error) {
                    showError('Error parsing CSV: ' + error.message);
                }
            };

            reader.onerror = function() {
                showError('Error reading file');
            };

            reader.readAsText(file);
        }

        function parseCSV(csvText) {
            const lines = csvText.trim().split('\n');
            if (lines.length < 2) {
                throw new Error('CSV must contain at least 2 rows');
            }

            // Parse header row
            const headers = parseCSVLine(lines[0]);
            
            if (headers.length < 2) {
                throw new Error('CSV must contain at least 2 columns');
            }

            // First column is labels, rest are data series
            const labels = [];
            const datasets = [];

            // Initialize datasets for each data column
            for (let i = 1; i < headers.length; i++) {
                datasets.push({
                    label: headers[i],
                    data: [],
                    borderColor: getColor(i - 1),
                    backgroundColor: getColor(i - 1, 0.1),
                    tension: 0.3,
                    fill: false
                });
            }

            // Parse data rows
            for (let i = 1; i < lines.length; i++) {
                if (lines[i].trim() === '') continue;
                
                const values = parseCSVLine(lines[i]);
                labels.push(values[0]);

                // Add values to respective datasets
                for (let j = 1; j < values.length && j <= datasets.length; j++) {
                    const value = parseFloat(values[j]);
                    datasets[j - 1].data.push(isNaN(value) ? null : value);
                }
            }

            return { labels, datasets };
        }

        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let insideQuotes = false;

            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                const nextChar = line[i + 1];

                if (char === '"') {
                    if (insideQuotes && nextChar === '"') {
                        current += '"';
                        i++;
                    } else {
                        insideQuotes = !insideQuotes;
                    }
                } else if (char === ',' && !insideQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }

            result.push(current.trim());
            return result;
        }

        function getColor(index, alpha = 1) {
            const colors = [
                `rgba(255, 99, 132, ${alpha})`,
                `rgba(54, 162, 235, ${alpha})`,
                `rgba(75, 192, 192, ${alpha})`,
                `rgba(255, 206, 86, ${alpha})`,
                `rgba(153, 102, 255, ${alpha})`,
                `rgba(255, 159, 64, ${alpha})`,
                `rgba(199, 199, 199, ${alpha})`,
                `rgba(83, 102, 255, ${alpha})`
            ];
            return colors[index % colors.length];
        }

        function createChart(data) {
            const ctx = document.getElementById('lineChart').getContext('2d');
            
            if (chart) {
                chart.destroy();
            }

            // Custom plugin to add labels in the middle of lines
            const lineLabelsPlugin = {
                afterDatasetsDraw(chart) {
                    const ctx = chart.ctx;
                    chart.data.datasets.forEach((dataset, datasetIndex) => {
                        const meta = chart.getDatasetMeta(datasetIndex);
                        const middleIndex = Math.floor(meta.data.length / 2);
                        const middlePoint = meta.data[middleIndex];

                        if (middlePoint && dataset.label) {
                            const x = middlePoint.x;
                            const y = middlePoint.y - 15;

                            ctx.fillStyle = dataset.borderColor;
                            ctx.font = 'bold 12px Arial';
                            ctx.textBaseline = 'middle';
                            ctx.fillText(dataset.label, x, y);
                        }
                    });
                }
            };

            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.labels,
                    datasets: data.datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        title: {
                            display: true,
                            text: 'Line Chart from CSV Data'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            title: {
                                display: true,
                                text: 'Values'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Categories'
                            }
                        }
                    }
                },
                plugins: [lineLabelsPlugin]
            });
        }

        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            errorDiv.classList.add('show');
        }
    </script>
</body>
</html>